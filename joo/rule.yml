apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: project-integrated-rules
  namespace: monitoring
  labels:
    release: prom
spec:
  groups:
  # ----------------------------------------------------------------
  # 1. ì¸í”„ë¼ (Node) ê´€ë ¨ ì•ŒëŒ
  # ----------------------------------------------------------------
  - name: node.rules
    rules:
    # CPU ì‚¬ìš©ëŸ‰ì´ 90% ì´ìƒì¼ ë•Œ ê²½ê³ 
    - alert: NodeHighCpuLoad
      expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[1m])) * 100) > 90
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "ë…¸ë“œ CPU ì‚¬ìš©ëŸ‰ ë†’ìŒ ({{ $labels.instance }})"
        description: "CPU ì‚¬ìš©ëŸ‰ì´ 90%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (í˜„ì¬ê°’: {{ $value }}%) ğŸ‘‰ <http://34.64.88.21:30030/graph?g0.expr=100-(avg%20by(instance)(rate(node_cpu_seconds_total%7Bmode%3D%22idle%22%7D%5B1m%5D))*100)&g0.tab=0|ê·¸ë˜í”„ ë³´ê¸°>"

    # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 90% ì´ìƒì¼ ë•Œ ê²½ê³ 
    - alert: NodeLowMemory
      expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 < 10
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "ë…¸ë“œ ë©”ëª¨ë¦¬ ë¶€ì¡± ({{ $labels.instance }})"
        description: "ê°€ìš© ë©”ëª¨ë¦¬ê°€ 10% ë¯¸ë§Œì…ë‹ˆë‹¤. (í˜„ì¬ê°’: {{ $value }}%) ğŸ‘‰ <http://34.64.88.21:30030/graph?g0.expr=(node_memory_MemAvailable_bytes%2Fnode_memory_MemTotal_bytes)*100&g0.tab=0|ê·¸ë˜í”„ ë³´ê¸°>"

    # ë””ìŠ¤í¬ ì—¬ìœ  ê³µê°„ì´ 15% ë¯¸ë§Œì¼ ë•Œ ê²½ê³ 
    - alert: NodeLowDiskSpace
      expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± ({{ $labels.instance }})"
        description: "ë””ìŠ¤í¬ ì—¬ìœ  ê³µê°„ì´ 15% ë¯¸ë§Œì…ë‹ˆë‹¤. ğŸ‘‰ <http://34.64.88.21:30030/graph?g0.expr=(node_filesystem_avail_bytes%7Bmountpoint%3D%22%2F%22%7D%2Fnode_filesystem_size_bytes%7Bmountpoint%3D%22%2F%22%7D)*100&g0.tab=0|ê·¸ë˜í”„ ë³´ê¸°>"

  # ----------------------------------------------------------------
  # 2. ì¿ ë²„ë„¤í‹°ìŠ¤ (Pod/Workload) ê´€ë ¨ ì•ŒëŒ
  # ----------------------------------------------------------------
  - name: kubernetes.rules
    rules:
    # íŒŒë“œê°€ ê³„ì† ì¬ì‹œì‘ë  ë•Œ
    - alert: PodRestartingTooMuch
      expr: increase(kube_pod_container_status_restarts_total[10m]) > 3
      for: 0m
      labels:
        severity: warning
      annotations:
        summary: "íŒŒë“œ ì¬ì‹œì‘ ë¹ˆë²ˆí•¨ ({{ $labels.pod }})"
        description: "ìµœê·¼ 10ë¶„ê°„ 3íšŒ ì´ìƒ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘‰ <http://34.64.88.21:30030/graph?g0.expr=increase(kube_pod_container_status_restarts_total%5B10m%5D)&g0.tab=0|ê·¸ë˜í”„ ë³´ê¸°>"

    # ë°°í¬ëœ íŒŒë“œ ê°¯ìˆ˜ê°€ ëª¨ìë„ ë•Œ
    - alert: DeploymentReplicasMismatch
      expr: kube_deployment_status_replicas_ready != kube_deployment_spec_replicas
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "ë””í”Œë¡œì´ë¨¼íŠ¸ ë³µì œë³¸ ë¶€ì¡± ({{ $labels.deployment }})"
        description: "ì¤€ë¹„ëœ íŒŒë“œ ìˆ˜ê°€ ì„¤ì •ëœ ìˆ˜ë³´ë‹¤ ì ìŠµë‹ˆë‹¤. ğŸ‘‰ <http://34.64.88.21:30030/graph?g0.expr=kube_deployment_status_replicas_ready!%3Dkube_deployment_spec_replicas&g0.tab=0|ê·¸ë˜í”„ ë³´ê¸°>"

  # ----------------------------------------------------------------
  # 3. ì• í”Œë¦¬ì¼€ì´ì…˜ (Gateway & ELK) ê´€ë ¨ ì•ŒëŒ
  # ----------------------------------------------------------------
  - name: application.rules
    rules:
    # HTTP ì—ëŸ¬ìœ¨(5xx) ê¸‰ì¦
    - alert: HighHttpErrorRate
      expr: sum(rate(http_requests_total{status=~"5.."}[10m])) / sum(rate(http_requests_total[10m])) * 100 > 5
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "HTTP ì—ëŸ¬ìœ¨ ê¸‰ì¦ ({{ $labels.job }})"
        description: "ìµœê·¼ 10ë¶„ê°„ 500ë²ˆëŒ€ ì—ëŸ¬ìœ¨ì´ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ğŸ‘‰ <https://34.47.100.137/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-15m,to:now))&_a=(columns:!(),dataSource:(dataViewId:c7860fa8-7926-4b1b-9c1b-be73c0e3111e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|ë¡œê·¸ í™•ì¸í•˜ê¸°(Kibana)>"

    # ì‘ë‹µ ì†ë„ ì§€ì—°
    - alert: HighLatency
      expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) > 1.0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ì‘ë‹µ ì†ë„ ì§€ì—° ({{ $labels.job }})"
        description: "P99 ì‘ë‹µ ì†ë„ê°€ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ğŸ‘‰ <https://34.47.100.137/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-15m,to:now))&_a=(columns:!(),dataSource:(dataViewId:c7860fa8-7926-4b1b-9c1b-be73c0e3111e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|ë¡œê·¸ í™•ì¸í•˜ê¸°(Kibana)>"

  # ----------------------------------------------------------------
  # 4. ê²Œì´íŠ¸ì›¨ì´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì•ŒëŒ
  # ----------------------------------------------------------------
  - name: gateway-business.rules
    rules:
    - alert: HighAuthFailures
      # 'failure' ê²°ê³¼ê°€ 5ë¶„ê°„ 5íšŒ ì´ìƒ ì¦ê°€í•˜ë©´ ê²½ë³´
      expr: increase(auth_events_total{result="failure"}[5m]) > 4
      for: 0m
      labels:
        severity: warning
      annotations:
        # reason ë¼ë²¨(ì˜ˆ: email_otp_invalid)ì„ ì œëª©ì— ë³´ì—¬ì¤ë‹ˆë‹¤.
        summary: "ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸‰ì¦ ({{ $labels.reason }})"
        description: "ìµœê·¼ 5ë¶„ê°„ ë¡œê·¸ì¸ ì‹¤íŒ¨ê°€ 5ê±´ ì´ìƒ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì›ì¸: {{ $labels.reason }} ğŸ‘‰ <https://34.47.100.137/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-15m,to:now))&_a=(columns:!(),dataSource:(dataViewId:c7860fa8-7926-4b1b-9c1b-be73c0e3111e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|ë¡œê·¸ í™•ì¸í•˜ê¸°(Kibana)>"

    # [ë³´ì•ˆ] ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…(ì°¨ë‹¨)
    - alert: HighRateLimitHits
      expr: increase(http_requests_total{status="429"}[5m]) > 50
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "ê³¼ë„í•œ ìš”ì²­ ì°¨ë‹¨ ë°œìƒ (Rate Limit)"
        description: "ìµœê·¼ 5ë¶„ê°„ 50ê±´ ì´ìƒì˜ ìš”ì²­ì´ ë ˆì´íŠ¸ ë¦¬ë¯¸íŠ¸ì— ì˜í•´ ì°¨ë‹¨(429)ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘‰ <https://34.47.100.137/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-15m,to:now))&_a=(columns:!(),dataSource:(dataViewId:c7860fa8-7926-4b1b-9c1b-be73c0e3111e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|ë¡œê·¸ í™•ì¸í•˜ê¸°(Kibana)>"

    # [ê°ì‚¬] ì„¤ì • ë³€ê²½
    - alert: GatewayConfigChanged
      expr: increase(audit_events_total[5m]) > 0
      for: 0m
      labels:
        severity: info
      annotations:
        summary: "ê²Œì´íŠ¸ì›¨ì´ ì„¤ì • ë³€ê²½ë¨"
        description: "ê²Œì´íŠ¸ì›¨ì´ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘‰ <https://34.47.100.137/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-15m,to:now))&_a=(columns:!(),dataSource:(dataViewId:c7860fa8-7926-4b1b-9c1b-be73c0e3111e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|ë¡œê·¸ í™•ì¸í•˜ê¸°(Kibana)>"
